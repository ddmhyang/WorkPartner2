<UserControl x:Class="WorkPartner.DashboardPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:local="clr-namespace:WorkPartner"
             mc:Ignorable="d" 
             d:DesignHeight="650" d:DesignWidth="1000"
             Loaded="Window_Loaded" IsVisibleChanged="DashboardPage_IsVisibleChanged">
    <UserControl.Resources>
        <!-- (Resource Dictionaries Merged from App.xaml for clarity) -->
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="250"/>
        </Grid.ColumnDefinitions>

        <!-- Left Column: Character & Tasks -->
        <DockPanel Grid.Column="0" Margin="10,10,5,10">
            <!-- Character Info Panel -->
            <Border DockPanel.Dock="Top" Style="{StaticResource SectionBorderStyle}" Padding="15" Margin="0,0,0,10">
                <StackPanel>
                    <TextBlock Text="내 캐릭터" Style="{StaticResource SectionHeaderStyle}" Margin="0,0,0,10"/>
                    <local:CharacterDisplay x:Name="CharacterPreview" Height="150"/>
                    <Grid Margin="0,10,0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="UsernameDisplay" Grid.Column="0" Text="사용자" FontWeight="Bold" VerticalAlignment="Center" FontSize="16"/>
                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Image Source="/images/coin.png" Width="16" Height="16" VerticalAlignment="Center"/>
                            <TextBlock x:Name="CoinDisplay" Text="0" VerticalAlignment="Center" Margin="5,0,0,0"/>
                        </StackPanel>
                    </Grid>
                    <TextBlock x:Name="CurrentTaskDisplay" Text="휴식 중" Foreground="Gray" FontSize="12" Margin="0,0,0,10"/>
                    <Button Content="아바타 꾸미기" Style="{StaticResource ActionButtonStyle}" Click="GoToClosetButton_Click"/>
                </StackPanel>
            </Border>

            <!-- Task List -->
            <Border Style="{StaticResource SectionBorderStyle}">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="과목 관리" Style="{StaticResource SectionHeaderStyle}" Margin="15,15,15,5"/>
                    <StackPanel DockPanel.Dock="Bottom" Margin="15,5,15,15">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" x:Name="TaskInput" KeyDown="TaskInput_KeyDown" Style="{StaticResource InputTextBoxStyle}"/>
                            <Button Grid.Column="1" Content="추가" Click="AddTaskButton_Click" Margin="5,0,0,0"/>
                        </Grid>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                            <Button Content="수정" Click="EditTaskButton_Click" Margin="0,0,5,0"/>
                            <Button Content="삭제" Click="DeleteTaskButton_Click"/>
                        </StackPanel>
                    </StackPanel>
                    <ListBox x:Name="TaskListBox" ItemsSource="{Binding TaskItems}" SelectionChanged="TaskListBox_SelectionChanged"
                             ScrollViewer.VerticalScrollBarVisibility="Auto" Margin="15,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Text}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
        </DockPanel>

        <!-- Center Column: Main Timer & Timeline -->
        <Grid Grid.Column="1" Margin="5,10,5,10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <Border Grid.Row="0" Style="{StaticResource SectionBorderStyle}" Margin="0,0,0,10">
                <StackPanel Margin="20">
                    <TextBlock Text="오늘의 학습 시간" TextAlignment="Center" FontSize="18" Foreground="Gray"/>
                    <TextBlock x:Name="MainTimeDisplay" Text="00:00:00" TextAlignment="Center" FontSize="64" FontWeight="Bold" Margin="0,5,0,10"/>
                    <TextBlock x:Name="SelectedTaskTotalTimeDisplay" Text="선택 과목 총계: 00:00:00" TextAlignment="Center" FontSize="14" Foreground="Gray"/>
                </StackPanel>
            </Border>

            <Border Grid.Row="1" Style="{StaticResource SectionBorderStyle}" Margin="0,0,0,0">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="10">
                        <Button Content="&lt;" Click="PrevDayButton_Click" Margin="0,0,5,0"/>
                        <Button Content="오늘" Click="TodayButton_Click"/>
                        <Button Content="&gt;" Click="NextDayButton_Click" Margin="5,0,0,0"/>
                        <DatePicker x:Name="TimelineDatePicker" SelectedDateChanged="TimelineDatePicker_SelectedDateChanged" Margin="10,0,0,0"/>
                    </StackPanel>
                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                        <Canvas x:Name="SelectionCanvas" Background="Transparent" 
                                MouseLeftButtonDown="SelectionCanvas_MouseLeftButtonDown"
                                MouseMove="SelectionCanvas_MouseMove" 
                                MouseLeftButtonUp="SelectionCanvas_MouseLeftButtonUp">
                            <StackPanel x:Name="TimeTableContainer" Orientation="Vertical"/>
                        </Canvas>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Right Column: To-Do & Helper Tools -->
        <DockPanel Grid.Column="2" Margin="5,10,10,10">
            <!-- To-Do List -->
            <Border DockPanel.Dock="Top" Style="{StaticResource SectionBorderStyle}" Padding="15" Margin="0,0,0,10" MaxHeight="350">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="오늘의 할 일" Style="{StaticResource SectionHeaderStyle}" Margin="0,0,0,10"/>
                    <StackPanel DockPanel.Dock="Bottom" Margin="0,10,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" x:Name="TodoInput" KeyDown="TodoInput_KeyDown" Style="{StaticResource InputTextBoxStyle}"/>
                            <Button Grid.Column="1" Content="추가" Click="AddTodoButton_Click" Margin="5,0,0,0"/>
                        </Grid>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                            <Button Content="수정" Click="EditTodoButton_Click" Margin="0,0,5,0"/>
                            <Button Content="삭제" Click="DeleteTodoButton_Click" />
                        </StackPanel>
                    </StackPanel>
                    <TreeView x:Name="TodoTreeView" ItemsSource="{Binding FilteredTodoItems}" PreviewMouseLeftButtonDown="TodoTreeView_PreviewMouseLeftButtonDown"
                              ScrollViewer.VerticalScrollBarVisibility="Auto" BorderThickness="0">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="{x:Type TreeViewItem}">
                                <Setter Property="IsExpanded" Value="True"/>
                            </Style>
                        </TreeView.ItemContainerStyle>
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate DataType="{x:Type local:TodoItem}" ItemsSource="{Binding SubTasks}">
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox IsChecked="{Binding IsCompleted, Mode=TwoWay}" VerticalAlignment="Center" Click="SaveTodos_Event"/>
                                    <TextBox Text="{Binding Text, UpdateSourceTrigger=PropertyChanged}" BorderThickness="0" Background="Transparent" VerticalAlignment="Center" KeyDown="TodoTextBox_KeyDown"/>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- Helper Tools -->
            <Border Style="{StaticResource SectionBorderStyle}" Padding="15">
                <StackPanel>
                    <TextBlock Text="학습 보조 기능" Style="{StaticResource SectionHeaderStyle}" Margin="0,0,0,10"/>
                    <Button x:Name="FocusModeButton" Content="집중 모드" Click="FocusModeButton_Click" Margin="0,0,0,5"/>
                    <Button Content="수동 기록 추가" Click="AddManualLogButton_Click" Margin="0,0,0,5"/>
                    <Button Content="메모장" Click="MemoButton_Click"/>
                    <Separator Margin="0,10,0,10"/>
                    <!-- Sound Mixer -->
                    <TextBlock Text="사운드 믹서" Margin="0,0,0,5" Foreground="Gray"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="파도" VerticalAlignment="Center"/>
                        <Slider Grid.Row="0" Grid.Column="1" Minimum="0" Maximum="1" Value="0" ValueChanged="SoundSlider_ValueChanged" Tag="wave"/>
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="숲" VerticalAlignment="Center"/>
                        <Slider Grid.Row="1" Grid.Column="1" Minimum="0" Maximum="1" Value="0" ValueChanged="SoundSlider_ValueChanged" Tag="forest"/>
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="비" VerticalAlignment="Center"/>
                        <Slider Grid.Row="2" Grid.Column="1" Minimum="0" Maximum="1" Value="0" ValueChanged="SoundSlider_ValueChanged" Tag="rain"/>
                        <TextBlock Grid.Row="3" Grid.Column="0" Text="불" VerticalAlignment="Center"/>
                        <Slider Grid.Row="3" Grid.Column="1" Minimum="0" Maximum="1" Value="0" ValueChanged="SoundSlider_ValueChanged" Tag="campfire"/>
                    </Grid>
                </StackPanel>
            </Border>
        </DockPanel>

        <!-- Hidden Panels -->
        <Border x:Name="SessionReviewPanel" Visibility="Collapsed" Background="#AA000000" Grid.ColumnSpan="3">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="방금 세션은 얼마나 집중했나요?" Foreground="White" FontSize="18" TextAlignment="Center" Margin="10"/>
                <StackPanel Orientation="Horizontal">
                    <Button Content="1점" Tag="1" Click="RateSessionButton_Click" Margin="5"/>
                    <Button Content="2점" Tag="2" Click="RateSessionButton_Click" Margin="5"/>
                    <Button Content="3점" Tag="3" Click="RateSessionButton_Click" Margin="5"/>
                    <Button Content="4점" Tag="4" Click="RateSessionButton_Click" Margin="5"/>
                    <Button Content="5점" Tag="5" Click="RateSessionButton_Click" Margin="5"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- AI Suggestion Area (can be placed in a corner) -->
        <TextBlock x:Name="AiSuggestionTextBlock" Text="" Foreground="DodgerBlue" Grid.Column="1" VerticalAlignment="Bottom" Margin="10"/>
        <TextBlock x:Name="ActiveProcessDisplay" Text="활성: " Foreground="Gray" Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="10"/>

    </Grid>
</UserControl>
