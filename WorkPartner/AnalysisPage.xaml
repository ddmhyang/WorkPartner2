<UserControl x:Class="WorkPartner.AnalysisPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://expression.blend/2008"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:local="clr-namespace:WorkPartner"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="900"
             IsVisibleChanged="AnalysisPage_IsVisibleChanged"
             Background="{DynamicResource MainBackgroundBrush}"
             FontFamily="Pretendard">
    <UserControl.Resources>
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
        </Style>
        <Style x:Key="PanelBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource SecondaryBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="5"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
        <Style TargetType="{x:Type TabItem}">
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Foreground" Value="{DynamicResource SecondaryTextBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TabItem}">
                        <Border Name="Border" BorderThickness="0,0,0,2" BorderBrush="Transparent" Margin="0,0,5,0">
                            <ContentPresenter x:Name="ContentSite"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"
                                              ContentSource="Header"
                                              Margin="10,2"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource AccentColorBrush}" />
                                <Setter Property="Foreground" Value="{DynamicResource AccentColorBrush}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="{x:Type TabControl}">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
        </Style>
    </UserControl.Resources>

    <ScrollViewer PreviewMouseWheel="HandlePreviewMouseWheel">
        <StackPanel Margin="20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="1" Text="분석" Style="{StaticResource HeaderTextStyle}" VerticalAlignment="Center"/>
            </Grid>


            <TextBlock Text="학습 통계 분석" FontSize="12" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryTextBrush}" Margin="0,15,0,5"/>
            <Border Style="{StaticResource PanelBorderStyle}">
                <StackPanel>
                    <TextBlock x:Name="TotalStudyTimeTextBlock" FontWeight="Bold" Margin="0,0,0,15"/>

                    <TabControl x:Name="AnalysisTabControl">
                        <TabItem Header="과목별 학습 시간" Name="TaskTimeTab">
                            <StackPanel Margin="0,15,0,0">
                                <DataGrid x:Name="TaskAnalysisGrid" AutoGenerateColumns="False" IsReadOnly="True" CanUserSortColumns="True" MinHeight="150">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="과목" Binding="{Binding TaskName}" Width="*"/>
                                        <DataGridTextColumn Header="총 학습 시간" Binding="{Binding TotalTimeFormatted}" Width="2*"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </TabItem>

                        <TabItem Header="집중도 분석" Name="FocusTab">
                            <StackPanel Margin="0,15,0,0">
                                <Grid Margin="0,0,0,15">
                                    <TextBlock Text="전체 평균 집중도" VerticalAlignment="Center"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <TextBlock x:Name="AverageFocusScoreTextBlock" Text="-.--" FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>
                                        <TextBlock Text="/ 5.0" VerticalAlignment="Bottom" Margin="2,0,0,1"/>
                                    </StackPanel>
                                </Grid>

                                <TextBlock Text="집중도 점수 분포 (횟수)" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,5"/>
                                <lvc:CartesianChart x:Name="FocusDistributionChart" Height="150" Margin="0,0,0,15">
                                    <lvc:CartesianChart.Series>
                                        <lvc:ColumnSeries Title="횟수" Values="{Binding FocusDistributionValues}" DataLabels="True"/>
                                    </lvc:CartesianChart.Series>
                                    <lvc:CartesianChart.AxisX>
                                        <lvc:Axis Title="점수" Labels="{Binding FocusDistributionLabels}"/>
                                    </lvc:CartesianChart.AxisX>
                                    <lvc:CartesianChart.AxisY>
                                        <lvc:Axis Title="기록 횟수" MinValue="0" LabelFormatter="{Binding YFormatterInt}"/>
                                    </lvc:CartesianChart.AxisY>
                                </lvc:CartesianChart>

                                <TextBlock Text="과목별 평균 집중도" FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,5"/>
                                <DataGrid x:Name="TaskFocusGrid" AutoGenerateColumns="False" IsReadOnly="True" CanUserSortColumns="True" MinHeight="100">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="과목" Binding="{Binding TaskName}" Width="*"/>
                                        <DataGridTextColumn Header="평균 집중도" Binding="{Binding AverageFocusScore, StringFormat={}{0:F1}점}" Width="*"/>
                                        <DataGridTextColumn Header="총 학습 시간" Binding="{Binding TotalTimeFormatted}" Width="*"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </TabItem>

                        <TabItem Header="시간대별 학습량" Name="HourlyTab">
                            <Grid Margin="0,15,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <lvc:CartesianChart Grid.Row="0" Name="HourlyFocusChart" Series="{Binding HourAnalysisSeries}" LegendLocation="None" Height="180">
                                    <lvc:CartesianChart.AxisX>
                                        <lvc:Axis Title="시간대" Labels="{Binding HourLabels}"/>
                                    </lvc:CartesianChart.AxisX>
                                    <lvc:CartesianChart.AxisY>
                                        <lvc:Axis Title="평균 집중도" LabelFormatter="{Binding YFormatter}" MinValue="0" MaxValue="5"/>
                                    </lvc:CartesianChart.AxisY>
                                </lvc:CartesianChart>

                                <lvc:CartesianChart Grid.Row="1" Name="HourlyTimeChart" Height="250" Margin="0,15,0,0">
                                    <lvc:CartesianChart.Series>
                                        <lvc:RowSeries Title="학습 시간(분)" Values="{Binding HourlyTimeValues}" DataLabels="True"/>
                                    </lvc:CartesianChart.Series>
                                    <lvc:CartesianChart.AxisY>
                                        <lvc:Axis Title="시간대" Labels="{Binding HourLabels}"/>
                                    </lvc:CartesianChart.AxisY>
                                    <lvc:CartesianChart.AxisX>
                                        <lvc:Axis Title="총 학습 시간 (분)" MinValue="0" LabelFormatter="{Binding YFormatterInt}"/>
                                    </lvc:CartesianChart.AxisX>
                                </lvc:CartesianChart>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </StackPanel>
            </Border>

            <TextBlock Text="AI 제안" Style="{StaticResource HeaderTextStyle}" Margin="0,15,0,5"/>
            <Border Style="{StaticResource PanelBorderStyle}">
                <StackPanel>
                    <TextBlock Text="💡 최적의 학습/휴식 패턴은?" FontWeight="Bold"/>
                    <TextBlock x:Name="WorkRestPatternSuggestionTextBlock" Text="데이터를 분석 중입니다..." TextWrapping="Wrap" Margin="0,5,0,0"/>
                </StackPanel>
            </Border>

            <TextBlock Text="AI 집중도 예측" Style="{StaticResource HeaderTextStyle}" Margin="0,15,0,5"/>
            <Border Style="{StaticResource PanelBorderStyle}">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox Grid.Column="0" x:Name="TaskPredictionComboBox" Margin="0,0,5,0"/>
                        <ComboBox Grid.Column="1" x:Name="DayOfWeekPredictionComboBox" Margin="0,0,5,0"/>
                        <ComboBox Grid.Column="2" x:Name="HourPredictionComboBox" Margin="0,0,5,0"/>
                        <Button Grid.Column="3" Content="예측하기" Click="PredictButton_Click"/>
                    </Grid>
                    <TextBlock x:Name="PredictionResultTextBlock" Text="" FontWeight="Bold" Margin="0,10,0,0"/>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>